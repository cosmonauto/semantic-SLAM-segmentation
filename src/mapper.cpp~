#include "mapper.h"

#include <pcl/visualization/cloud_viewer.h>
#include <pcl/filters/voxel_grid.h>
#include <pcl/io/pcd_io.h>
#include <pcl/visualization/pcl_visualizer.h>
//#include <pcl/filters/radius_outlier_removal.h>  
//#include <pcl/filters/statistical_outlier_removal.h>

using namespace rgbd_tutor;

Mapper::PointCloud::Ptr Mapper::generatePointCloud( const RGBDFrame::Ptr &frame )
{
    semantic_motion_fuse(frame);

    PointCloud::Ptr tmp( new PointCloud() );
    if ( frame->pointcloud == nullptr )
    {
        // point cloud is null ptr
        frame->pointcloud = boost::make_shared<PointCloud>();
#pragma omp parallel for
        for ( int m=0; m<frame->depth.rows; m+=1 )
        {
	    uchar* motion_ptr = moving_mask.ptr<uchar>(m);
            for ( int n=0; n<frame->depth.cols; n+=1 )
            {
                ushort d = frame->depth.ptr<ushort>(m)[n];
                if (d == 0)
                    continue;
                if (d > max_distance * frame->camera.scale)
                    continue;
		if (motion_ptr[n] == 255)
		    continue;

                PointT p;
                cv::Point3f p_cv = frame->project2dTo3d(n, m);
                p.b = frame->semantic.ptr<uchar>(m)[n*3];
                p.g = frame->semantic.ptr<uchar>(m)[n*3+1];
                p.r = frame->semantic.ptr<uchar>(m)[n*3+2];

                if (
                        (p.b==128 && p.g==128 && p.r==128) || //sky
                        //(p.b==0 && p.g==0 && p.r==128) || //building
                        (p.b==128 && p.g==192 && p.r==192) || // pole
                        (p.b==0 && p.g==69 && p.r==255) || // lane
                        //(p.b==128 && p.g==64 && p.r==128) || // road
                        //(p.b==222 && p.g==40 && p.r==60) || // sidewalk
                        //(p.b==0 && p.g==128 && p.r==128) || // vegetable
                        (p.b==128 && p.g==128 && p.r==192) || // sign
                        (p.b==128 && p.g==64 && p.r==64) || // fence
                        //(p.b==128 && p.g==0 && p.r==64) // car
                        (p.b==0 && p.g==64 && p.r==64) || // pedestrian
                        (p.b==192 && p.g==128 && p.r==0) //cyclist
              